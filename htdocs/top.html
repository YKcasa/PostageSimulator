<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>郵便料金シミュレーション ver0.80</title>
        <link rel="stylesheet" href="styles/style.css">
    </head>
    <body>
        <header>
            <h3>かんたん<br>郵便料金<br>シミュレーション</h3>
        </header>
        <div class="container">
            <p>ver.8.2</p>
            <p>送りたいものと封筒のサイズから<br>郵便料金の目安を算出します</p>
            <div class="menu-box">
                <div class="input-area">
                    <h4>STEP 1</h4>
                    <h2>送りたいものを選んでください<span>（複数可）</span></h2>
                    <div id="inclusion"></div>
                </div>
                <!-- <button class="accordion-btn">ダミー：アコーディオンメニューの練習</button>
                <div class="accordion-panel">
                    <p>サイズ直接入力機能は作成中です・・・</p>
                    <input type="text" value="エラー処理めんどうだなあ"/>
                </div> -->
                <div class="input-area" id="envelope">
                    <h4>STEP2</h4>
                    <h2>封筒のサイズは？</h2>
                    <div id="envelope-select"></div>
                </div>
            </div>
        </div>
        <div class="simulation-area">
            <div class="simu-container">
                <div class="simu-upper">
                    <div class="result-1">
                        <p>郵便料金<span>（目安）</span></p>
                        <div id="display-postage"></div>
                    </div>
                    <div class="result-2">
                        <div id="display-mailtype"></div>
                        <p> --- </p>
                        <div id="display-weight-limit"></div>
                    </div>
                </div>
                <div class="simu-downer">
                    <div class="simu-display">
                        <p>サイズ</p>
                        <div id="display-size-area"></div>
                    </div>
                    <div class="simu-display">
                        <p>厚み（目安）</p>
                        <div id="display-thickness-area"></div>
                    </div>
                    <div class="simu-display">
                        <p>重さ（目安）</p>
                        <div id="display-weight-area"></div>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <p>ここにフッター</p>
        </footer>
        <script src="scripts/settings.js"></script>
        <script>

            // --- 表示域との紐づけ
            // 封筒ボタンエリア
            const envelopeArea = document.getElementById('envelope-select');
            // シミュレーションエリア
            const displayPostage = document.getElementById('display-postage');
            const displayMailType = document.getElementById('display-mailtype');
            const displayWeightLimit = document.getElementById('display-weight-limit');
            const displaySize = document.getElementById('display-size-area');
            const displayThickness = document.getElementById('display-thickness-area');
            const displayWeight = document.getElementById('display-weight-area');
            
            // --- 変数定義
            let componentsInstances;
            let inclMaxLong, inclMaxShort, inclTotalThicknes, inclTotalWeight; // 内容物の最大長辺と短辺、内容物全体の厚さと重さ
            let evLongSide, evShortSide, totalThickness, totalWeight; // 封筒の長辺と短辺、封筒込みの厚さと重さ
            let nextWeightLimit;
            
            
            // --- 内容物のクラス
            class Inclusion {
                constructor(key, label, weight, thickness, type, max, unitName){
                    this.key = key;
                    this.label = label;
                    if (type == 'paper' || type == 'file'){
                        this.basicWeight = weight / (788 * 1091); // 紙の重さ単位：kg/四六判(788mm*1091mm)1000枚　→　g/1mm2　に変換する
                    }else{
                        this.basicWeight = weight;
                    }
                    this.unitWeight = 0;
                    this.basicThickness = thickness;
                    this.foldingFactor = 1; // 二つ折り・三つ折り換算用の係数
                    this.unitThickness = 0;
                    this.materialType = type;
                    this.longSide = 0;
                    this.shortSide = 0;
                    this.quantity = 0;
                    this.quantityMax = max; // ドロップダウンメニューの最大値
                    this.unitName = unitName;
                    this.sizeStandard = sizeStandards[this.materialType] || sizeStandards.default;

                    this.createElements(); // インスタンス作成時に画面要素を作成
                    this.paperSizeSelect = document.getElementById(this.key + '-size');
                    this.quantitySelect = document.getElementById(this.key + '-quantity');

                    this.attachListeners(); // 作成した画面要素にイベントリスナーを付与
                }

                createElements() {
                    // 要素を配置するdiv
                    const div = document.createElement('div');
                    div.classList.add('inclusion');
                    document.getElementById('inclusion').appendChild(div);
        
                    // 内容物名称のラベル
                    const label = document.createElement('label');
                    label.textContent = this.label;
                    div.appendChild(label);
        
                    // サイズ選択ドロップダウンメニュー
                    const sizeSelectMenu = document.createElement('select');
                    sizeSelectMenu.id = this.key + '-size';                                         
                    for (const size in this.sizeStandard) { 
                        const option = document.createElement('option');
                        option.value = size;
                        option.text = size;
                        sizeSelectMenu.appendChild(option);
                    }
                    div.appendChild(sizeSelectMenu);

                    // 数量選択ドロップダウンメニュー
                    const quantityInputMenu = document.createElement('select');
                    quantityInputMenu.id = this.key + '-quantity';
                    for (let i = 0; i <= this.quantityMax; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.text = i;
                        quantityInputMenu.appendChild(option);
                    }
                    div.appendChild(quantityInputMenu);
                    
                    // 単位のラベル
                    const unitLabel = document.createElement('label');
                    unitLabel.textContent = this.unitName;
                    div.appendChild(unitLabel);
                }
                
                attachListeners() {
                    // const paperSizeSelect = document.getElementById(this.key + '-size');
                    // const quantitySelect = document.getElementById(this.key + '-quantity');
                    
                    // paperSizeSelect.addEventListener('change', this.updateInclusion.bind(this));
                    // quantitySelect.addEventListener('change', this.updateInclusion.bind(this));
                    this.paperSizeSelect.addEventListener('change', this.updateInclusion.bind(this));
                    this.quantitySelect.addEventListener('change', this.updateInclusion.bind(this));
                }

                updateInclusion(){ // ドロップダウンの選択内容で内容物のインスタンスを更新する
                    updateDisplay(displayPostage, '');
                    updateDisplay(displayMailType, '');
                    updateDisplay(displayWeightLimit, '');

                    // const paperSizeSelect = document.getElementById(this.key + '-size');
                    // const quantitySelect = document.getElementById(this.key + '-quantity');
                    // quantitySelect.classList.remove('select-emphasis');
                    // paperSizeSelect.classList.remove('select-emphasis');
                    envelopeArea.innerHTML = '';
                    this.quantitySelect.classList.remove('select-emphasis');
                    this.paperSizeSelect.classList.remove('select-emphasis');

                    // const selectedSize = document.getElementById(this.key + '-size').value;
                    const selectedSize = this.paperSizeSelect.value;
                    // const quantity = document.getElementById(this.key + '-quantity').value;
                    const quantity = this.quantitySelect.value;

                    if (selectedSize === 'サイズを選択' && quantity === '0'){
                        this.quantitySelect.classList.remove('select-emphasis');
                        this.paperSizeSelect.classList.remove('select-emphasis');
                    
                    }else if (selectedSize === 'サイズを選択'){
                        this.paperSizeSelect.classList.add('select-emphasis');
                    
                    }else if (quantity === '0'){
                        this.quantitySelect.classList.add('select-emphasis');

                        calculateInclusionTotal();
                        generateEnvelopeButtons();

                    }else{

                        this.longSide = this.sizeStandard[selectedSize].long;
                        this.shortSide = this.sizeStandard[selectedSize].short;
                        this.foldingFactor = this.sizeStandard[selectedSize].foldingFactor;
        
                        this.quantity = Number(quantity);
                        this.unitWeight = Number(this.basicWeight * this.longSide * this.shortSide * this.foldingFactor * this.quantity);
                        this.unitThickness = Number(this.basicThickness * this.foldingFactor * quantity);
        
                        console.log(this.key, this.quantity, this.unitWeight, this.unitThickness)
                        
                        calculateInclusionTotal();
                        generateEnvelopeButtons();

                    }
                }
                
            }

            // --- 内容物の合算 --- 内容物の最大の長辺・短辺、内容物全体の厚さ・重さを計算
            function calculateInclusionTotal() {
                inclMaxLong = componentsInstances.reduce((max, instance) => Math.max(max, instance.longSide), 0);
                inclMaxShort = componentsInstances.reduce((max, instance) => Math.max(max, instance.shortSide), 0);
                
                inclTotalThicknes = componentsInstances.map(item => item.unitThickness).reduce((sum, curr) => sum + curr, 0);
                updateDisplay(displayThickness, `${inclTotalThicknes.toFixed(1)} mm`, 500);
                
                inclTotalWeight = componentsInstances.map(item => item.unitWeight).reduce((sum, curr) => sum + curr, 0);
                updateDisplay(displayWeight, `${inclTotalWeight.toFixed(2)} g`, 500);
                
                console.log(`長辺:${inclMaxLong}, 短辺:${inclMaxShort}, 厚さ:${inclTotalThicknes}, 重さ:${inclTotalWeight}`);  

            }    


            // --- 封筒ボタン生成 --- 内容物が入るサイズの封筒ボタンを表示し、イベントリスナーを設置
            function generateEnvelopeButtons() {
                envelopeArea.innerHTML = ''; 
                updateDisplay(displaySize, '');

                Object.keys(envelopeData).forEach(envelopeId => {
                    const data = envelopeData[envelopeId];
                    if(data.long > inclMaxLong && data.short > inclMaxShort){
                        const button = document.createElement("button");
                        button.id = envelopeId;
                        button.textContent = `${data.value}`;
                        button.classList.add('envelope-btn');
                        envelopeArea.appendChild(button);
                    }
                });
                
                const envelopeButtons = document.querySelectorAll('.envelope-btn');
                envelopeButtons.forEach(btns => btns.addEventListener('click', calculatePostage));
                
            }
            
            
            // --- 封筒ボタン選択時　-> 封筒サイズ読み込み、郵便種別判定
            function calculatePostage(){
                loadEnvelopDatas();
                postalClassify();
            }
            
            // 封筒サイズ読み込み
            function loadEnvelopDatas(){
                updateDisplay(displayThickness,'');
                updateDisplay(displayWeight,'');

                const selectedEnvelopeSize = envelopeData[event.target.id]; //封筒データセットから
                evLongSide = selectedEnvelopeSize.long;
                evShortSide = selectedEnvelopeSize.short;
                updateDisplay(displaySize, `${evLongSide} mm × ${evShortSide} mm`, 500);
                
                totalThickness = inclTotalThicknes + selectedEnvelopeSize.thickness;
                updateDisplay(displayThickness, `${totalThickness.toFixed(1)} mm`, 500);
                
                totalWeight = inclTotalWeight + selectedEnvelopeSize.weight;
                updateDisplay(displayWeight, `${totalWeight.toFixed(2)} g`, 500);
                
                // 計算確認用
                console.log(`封筒長辺：${evLongSide},封筒短辺：${evShortSide},厚さ：${totalThickness},重さ：${totalWeight}`);
                // 計算確認用ここまで
            }
            
            // 郵便種別判定 -> 郵便料金判定
            // --- !!! 料金変更の閾値はここにハードコーディングしているので郵便仕様変更時は修正する !!! ---
            function postalClassify() {
                let mailType, diplayFee;
                
                if (totalWeight > 4000){ // 4kg超は取扱い不可。除外
                    mailType = "４ｋｇを超えるものは、手紙ではなくゆうパック等をお使いください";
                }else if( evLongSide > 600 || (evLongSide + evShortSide + totalThickness) > 900 ){
                    mailType = "９０サイズをオーバーしています。ゆうパック等をお使いください";
                }else{
                    if(totalWeight > 1000){ // 1kg超は定形外・規格外
                        mailType = `定形外郵便物・規格外`;
                        displayFee = determinePostage(extraPostageArray, totalWeight);
                    }else if(totalWeight > 50){ // 50g超は定形外
                        if (evLongSide > 340 || evShortSide > 250 || totalThickness > 30){
                            mailType = `定形外郵便物・規格外`;
                            displayFee = determinePostage(extraPostageArray, totalWeight);
                        }else{
                            mailType = `定形外郵便物・規格内`;
                            displayFee = determinePostage(nonstandardPostageArray, totalWeight);
                        }   
                    }else{ //50g以内は大きさで３パターン
                        if(evLongSide > 340 || evShortSide > 250 || totalThickness > 30){
                            mailType = `定形外郵便物・規格外`;
                            displayFee = determinePostage(extraPostageArray, totalWeight);
                        }else if(evLongSide > 235 || evShortSide > 120 || totalThickness > 10){
                            mailType = `定形外郵便物・規格内`;
                            displayFee = determinePostage(nonstandardPostageArray, totalWeight);
                        }else{
                            mailType = `定形郵便物`;
                            displayFee = determinePostage(standardPostageArray, totalWeight);
                        };
                    };
                };
    
                updateDisplay(displayMailType, mailType, 500);
                updateDisplay(displayWeightLimit, `あと${(nextWeightLimit - totalWeight).toFixed(1)}ｇまで同一料金です`, 500);
                displayPostage.textContent = `${displayFee} 円`;
                
            }

            // 郵便料金判定
            function determinePostage(postalClassArray, weight) {
                for (i = 0; i < postalClassArray.length; i++){
                    if (weight <= postalClassArray[i].weightLimit){
                        nextWeightLimit = postalClassArray[i].weightLimit;
                        return postalClassArray[i].fee;
                    };
                }
            }

            
            // --- 表示エリアへの表示用共通処理
            function updateDisplay(area, contents, delay = 0){
                area.animate([{opacity: '0'},{opacity: '1'}], delay);
                area.textContent = `${contents}`;
            }


            // --- 初期化処理　配列データより、インスタンスを作成する
            function initialize() {
                componentsInstances = inclusions.map(data => new Inclusion(data.id, data.label, data.weight, data.thickness, data.type, data.max, data.unitName));
            }
            

            // --- 画面読み込み時に初期化処理を行う
            document.addEventListener('DOMContentLoaded', initialize);
                

        </script>
        <!-- <script src="javascript.js"></script> -->
    </body>
</html>